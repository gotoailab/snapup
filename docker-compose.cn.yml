# 中国版 Docker Compose 配置
# 使用国内镜像源优化构建速度

version: '3.8'

services:
  chrome:
    build:
      context: .
      dockerfile: Dockerfile.chrome.cn
    image: snapup-chrome:latest
    container_name: snapup-chrome
    restart: unless-stopped
    ports:
      - "9222:9222"
    shm_size: '2gb'
    networks:
      - snapup-network
    # 等待一定时间让 Chrome 启动
    # chromedp/headless-shell 不包含健康检查工具，所以使用简单的延迟
    healthcheck:
      test: ["NONE"]

  # SnapUp 主应用 - HTTP Server
  snapup:
    build:
      context: .
      dockerfile: Dockerfile.cn
      args:
        - GOPROXY=https://goproxy.cn,https://mirrors.aliyun.com/goproxy/,direct
    container_name: snapup-app
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - RUN_MODE=http
      - SERVER_PORT=8080
      - OUTPUT_DIR=/app/screenshots
      - CHROME_WS_URL=ws://chrome:9222
    volumes:
      - ./screenshots:/app/screenshots
    depends_on:
      - chrome
    # 添加启动延迟，等待 Chrome 容器就绪
    command: sh -c "sleep 10 && /app/snapup -mode=http -port=8080 -output=/app/screenshots"
    networks:
      - snapup-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # SnapUp MCP Server（按需启动）
  snapup-mcp:
    build:
      context: .
      dockerfile: Dockerfile.cn
      args:
        - GOPROXY=https://goproxy.cn,https://mirrors.aliyun.com/goproxy/,direct
    container_name: snapup-mcp
    restart: "no"  # 不自动重启，需要手动启动
    environment:
      - RUN_MODE=mcp
      - OUTPUT_DIR=/app/screenshots
      - CHROME_WS_URL=ws://chrome:9222
    volumes:
      - ./screenshots:/app/screenshots
    depends_on:
      - chrome
    command: sh -c "sleep 10 && /app/snapup -mode=mcp -output=/app/screenshots"
    networks:
      - snapup-network
    stdin_open: true  # 保持 stdin 打开，MCP 协议需要
    tty: true         # 分配伪终端
    profiles:
      - mcp           # 使用 profile，默认不启动

networks:
  snapup-network:
    driver: bridge

volumes:
  screenshots:
    driver: local

