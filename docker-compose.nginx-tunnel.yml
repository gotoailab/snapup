# Docker Compose 配置 - 使用 Nginx + 内网穿透
version: '3.8'

services:
  chrome:
    build:
      context: .
      dockerfile: Dockerfile.chrome
    image: snapup-chrome:latest
    container_name: snapup-chrome
    restart: unless-stopped
    # 不直接暴露 9222，通过 nginx 转发
    shm_size: '2gb'
    networks:
      - snapup-network
    healthcheck:
      test: ["NONE"]

  # Nginx WebSocket 代理
  nginx-ws:
    image: nginx:alpine
    container_name: snapup-nginx-ws
    restart: unless-stopped
    ports:
      - "9223:9223"  # 对外暴露的端口
    volumes:
      - ./nginx-websocket.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - snapup-network
    depends_on:
      - chrome

  # frp 客户端 - 穿透 Nginx 代理端口
  frpc:
    image: snowdreamtech/frpc:latest
    container_name: snapup-frpc
    restart: unless-stopped
    volumes:
      - ./frpc.toml:/etc/frp/frpc.toml:ro
    networks:
      - snapup-network
    depends_on:
      - nginx-ws
    command: ["frpc", "-c", "/etc/frp/frpc.toml"]

  snapup:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: snapup
    ports:
      - "8080:8080"
    volumes:
      - ./screenshots:/app/screenshots
    environment:
      - PORT=8080
      - CHROME_WS_URL=ws://chrome:9222
    depends_on:
      - chrome
    command: sh -c "sleep 10 && /app/snapup -mode=http -port=8080 -output=/app/screenshots"
    networks:
      - snapup-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  snapup-network:
    driver: bridge

